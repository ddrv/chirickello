# Модель данных

Начнём с пользователя. У пользователя есть баланс, аутентификационная информация, набор ролей и задачи.
У баланса есть лог.
У задачи есть стоимость выполнения, стоимость назначения и статус.

```text
        ┌─────────┐  ┌─────┐
        │ balance │─→│ log │
        └─────────┘  └─────┘
             ↑
             │
┌──────┐  ┌──────┐  ┌───────┐
│ auth │←─│ user │─→│ roles │
└──────┘  └──────┘  └───────┘
             │
             ↓
┌──────┐  ┌──────┐  ┌─────┐
│ cost │←─│ task │─→│ tax │
└──────┘  └──────┘  └─────┘
             │
             ↓
         ┌────────┐
         │ status │
         └────────┘
```

# Контекст

Auth:
- Создание пользователя
- Смена роли

TaskTracker
- Создание задачи
- Шаффл исполнителей задач
- Выполнение задачи

Accounting
- Списание средств за назначение задачи
- Начисление средств за выполнение задачи
- Расчёт баланса за день
- Выплата оплаты сотрудникам
- Отправка на почту суммы выплаты

Analytics
- Собрать и подвести статистику по платёжным операциям

 

# Домены

```text

╔══ AUTH ═══════════════════════╗
║ ┌──────┐  ┌──────┐  ┌───────┐ ║
║ │ auth │←─│ user │─→│ roles │ ║
║ └──────┘  └──────┘  └───────┘ ║
╚═══════════════════════════════╝

╔══ TASK TRACKER ═══════════════╗
║           ┌──────┐  ┌───────┐ ║
║           │ user │─→│ roles │ ║
║           └──────┘  └───────┘ ║
║              │                ║
║              ↓                ║
║           ┌──────┐            ║
║           │ task │            ║
║           └──────┘            ║
║              │                ║
║              ↓                ║
║          ┌────────┐           ║
║          │ status │           ║
║          └────────┘           ║
╚═══════════════════════════════╝

╔══ ACCOUNTING ═════════════════╗
║         ┌─────────┐  ┌─────┐  ║
║         │ balance │─→│ log │  ║
║         └─────────┘  └─────┘  ║
║              ↑                ║
║              │                ║
║           ┌──────┐  ┌───────┐ ║
║           │ user │─→│ roles │ ║
║           └──────┘  └───────┘ ║
║              │                ║
║              ↓                ║
║ ┌──────┐  ┌──────┐  ┌─────┐   ║
║ │ cost │←─│ task │─→│ tax │   ║
║ └──────┘  └──────┘  └─────┘   ║
║              │                ║
║              ↓                ║
║          ┌────────┐           ║
║          │ status │           ║
║          └────────┘           ║
╚═══════════════════════════════╝

╔══ ANALYTICS ══════════════════╗
║         ┌─────────┐           ║
║         │ balance │           ║
║         └─────────┘           ║
║              ↑                ║
║              │                ║
║           ┌──────┐  ┌───────┐ ║
║           │ user │─→│ roles │ ║
║           └──────┘  └───────┘ ║
║              │                ║
║              ↓                ║
║ ┌──────┐  ┌──────┐            ║
║ │ cost │←─│ task │            ║
║ └──────┘  └──────┘            ║
╚═══════════════════════════════╝

```


# Схема сервисов и их взаимодействий

```text
┌─────────────────────────────────────────────────────────────────────────┐   1    ┌─────────────────────────────┐
│                                    UI                                   │←──────→│     Сервис авторизации      │
└─────────────────────────────────────────────────────────────────────────┘        └─────────────────────────────┘
                                      ↑                                                      ↑   ↑   ↑         │
                                     0│                                                      │   │   │        2│
                                      ↓                                                      │   │   │        3│
┌─────────────────────────────────────────────────────────────────────────┐                  │   │   │         │
│                                 API шлюз                                │                  │   │   │         │
└─────────────────────────────────────────────────────────────────────────┘                  │   │   │         │
         ↑                            ↑                           ↑                          │   │   │         │
        0│                           0│                          0│                          │   │   │         │
         │   ┌────────────────────────│───────────────────────────│──────────────────────────┘   │   │         │
         │   │                        │   ┌───────────────────────│──────────────────────────────┘   │         │
         │   │                        │   │                       │   ┌──────────────────────────────┘         │
         │  1│                        │  1│                       │  1│                                        │
         ↓   ↓                        ↓   ↓                       ↓   ↓                                        │
┌───────────────────────┐  ┌───────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐ │
│     Трекер задач      │  │       Аккаунтинг      │  │       Аналитика         │  │   Сервис нотификаций    │ │
└───────────────────────┘  └───────────────────────┘  └─────────────────────────┘  └─────────────────────────┘ │
         │   ↑                        │   ↑                       │   ↑                         ↑              │
        4│   │2                      6│   │2                      │   │2                        │2             │
        5│   │3                      7│   │3                      │   │3                        │10            │
         │   │                       8│   │4                      │   │6                        │              │
         │   │                       9│   │5                      │   │7                        │              │
         │   │                      10│   │                       │   │8                        │              │
         │   │                        │   │                       │   │9                        │              │
         ↓   │                        ↓   │                       ↓   │                         │              ↓
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                   Шина сообщений                                               │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

# Межсервисные взаимодействия

0. Проксирующие запросы (sync)
1. Процесс авторизации (sync)
2. Пользователь создан (CUD event)
3. Пользователь переквалифицирован (BE)
4. Задача назначена (BE)
5. Задача выполнена (BE)
6. Задача оценена (BE)
7. Средства списаны с баланса (BE)
8. Средства начислены на баланс (BE)
9. Баланс за день рассчитан (BE)
10. Оплата за день произведена (BE)

# События

## Пользователь создан

 - Актором является Пользователь.
 - Команда: `Создать пользователя`.
 - Продьюсится сервисом авторизации в момент регистрации нового пользователя в системе.
 - Консьюмится всеми сервисами системы в целях синхронизации данных.
 - Данные: `user.*`.

## Пользователь переквалифицирован

 - Актором является Админ.
 - Команда: `Изменить роли пользователя`.
 - Продьюсится сервисом авторизации в момент наделения пользователю другого набора ролей.
 - Консьюмится сервисами Трекера задач, Аналитики и Аккаунтинга в целях синхронизации данных.
 - Данные: `user.id`, `user.roles`.

## Задача назначена

 - Актором является Пользователь.
 - Команды: `Создать пользователя`, `Шаффл незавершенных задач`.
 - Продьюсится сервисом Трекера задач в момент создания задачи и шаффла незавершенных задач.
 - Консьюмится сервисами Аналитики и Аккаунтинга.
 - Данные: `task.id`, `task.assigned`, `date`.

## Задача выполнена

 - Актором является Пользователь.
 - Команда: `Завешить задачу`.
 - Продьюсится сервисом Трекера задач в момент выполнения.
 - Консьюмится сервисами Аналитики и Аккаунтинга.
 - Данные: `task.id`, `task.assigned`, `date`.

## Задача оценена

 - Актором является событие `Задача назначена`.
 - Команда: `Оценить задачу`.
 - Продьюсится сервисом Аккаунтинга в момент установки стоимости назначения и стоимости завершения.
 - Консьюмится сервисом Аналитики.
 - Данные: `task.id`, `task.cost`, `task.tax`, `date`.

## Средства списаны с балансы

 - Актором является событие `Задача назначена`.
 - Команды: `Создать пользователя`, `Шаффл незавершенных задач`.
 - Продьюсится сервисом Аккаунтинга в момент списания средств со счета пользователя.
 - Консьюмится сервисом Аналитики.
 - Данные: `user.id`, `amount`, `comment`, `date`.

## Средства начислены на баланс

 - Актором является событие `Задача выполнена`.
 - Команда: `Завешить задачу`.
 - Продьюсится сервисом Аккаунтинга в момент зачисления средств со счета пользователя.
 - Консьюмится сервисом Аналитики.
 - Данные: `user.id`, `amount`, `comment`, `date`.

## Баланс за день рассчитан

 - Актором является завершение рабочего дня.
 - Команда: `Рассчитать баланс за день`.
 - Продьюсится сервисом Аккаунтинга.
 - Консьюмится сервисами Аналитики и Нотификации.
 - Данные: `user.id`, `amount`, `date`.

## Оплата за день произведена

 - Актором является событие `Баланс за день рассчитан`.
 - Команда: `Отправить нотификации`.
 - Продьюсится сервисом Аккаунтинга.
 - Консьюмится сервисом Нотификации.
 - Данные: `user.id`, `amount`, `date`.
